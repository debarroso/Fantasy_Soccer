create materialized view data_models.mv_player_matches as (
    select
        l.match_id,
        l.match_date,
        l.season,
        l.competition,
        CASE
            WHEN l.home is true THEN split_part(mm.home_team_link, '/', 4)
            ELSE split_part(mm.away_team_link, '/', 4)
        END AS team_id,
        l.team,
        l.formation,
        l.player_link,
        p.player,
        l.starter,
        p.country_link,
        p.nationality,
        p.position,
        p.age,
        p.minutes,
        p.goals,
        p.assists,
        p.pens_made,
        p.pens_att,
        p.shots,
        p.shots_on_target,
        p.cards_yellow,
        p.cards_red,
        p.touches,
        p.tackles,
        p.interceptions,
        p.blocks,
        p.xg,
        p.npxg,
        p.xg_assist,
        p.sca,
        p.gca,
        p.passes_completed,
        p.passes,
        p.passes_pct,
        p.progressive_passes,
        p.dribbles_completed,
        p.dribbles,
        p.passes_total_distance,
        p.passes_progressive_distance,
        p.passes_completed_short,
        p.passes_short,
        p.passes_pct_short,
        p.passes_completed_medium,
        p.passes_medium,
        p.passes_pct_medium,
        p.passes_completed_long,
        p.passes_long,
        p.passes_pct_long,
        p.pass_xa,
        p.assisted_shots,
        p.passes_into_final_third,
        p.passes_into_penalty_area,
        p.crosses_into_penalty_area,
        p.passes_live,
        p.passes_dead,
        p.passes_free_kicks,
        p.through_balls,
        p.passes_switches,
        p.crosses,
        p.throw_ins,
        p.corner_kicks,
        p.corner_kicks_in,
        p.corner_kicks_out,
        p.corner_kicks_straight,
        p.passes_offsides,
        p.passes_blocked,
        p.tackles_won,
        p.tackles_def_3rd,
        p.tackles_mid_3rd,
        p.tackles_att_3rd,
        p.dribble_tackles,
        p.dribbles_vs,
        p.dribble_tackles_pct,
        p.dribbled_past,
        p.blocked_shots,
        p.blocked_passes,
        p.tackles_interceptions,
        p.clearances,
        p.errors,
        p.touches_def_pen_area,
        p.touches_def_3rd,
        p.touches_mid_3rd,
        p.touches_att_3rd,
        p.touches_att_pen_area,
        p.touches_live_ball,
        p.dribbles_completed_pct,
        p.miscontrols,
        p.dispossessed,
        p.passes_received,
        p.progressive_passes_received,
        p.cards_yellow_red,
        p.fouls,
        p.fouled,
        p.offsides,
        p.pens_won,
        p.pens_conceded,
        p.own_goals,
        p.ball_recoveries,
        p.aerials_won,
        p.aerials_lost,
        p.aerials_won_pct
    from raw.lineups l
        inner join raw.players p
            on l.match_id = p.match_id
            and l.player_link = p.player_link
        inner join raw.match_metadata mm
            on l.match_id = mm.match_id
);